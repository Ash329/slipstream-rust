name: Build Release
on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup MSVC Developer Command Prompt
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
      
      - name: Install Rust
        run: |
          rustup update stable
          rustup default stable-x86_64-pc-windows-msvc
          rustup target add x86_64-pc-windows-msvc
      
      - name: Install CMake and Ninja
        run: |
          choco install cmake ninja -y
      
      - name: Verify Environment
        run: |
          cmake --version
          ninja --version
          rustc --version --verbose
          cargo --version
        
      - name: Build slipstream-client
        env:
          OPENSSL_STATIC: 1
          PICOQUIC_AUTO_BUILD: 1
          CMAKE_GENERATOR: Ninja
        run: |
          cargo build -p slipstream-client --release --target x86_64-pc-windows-msvc --features openssl/vendored
      
      - name: Upload Windows Executable
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: slipstream-client-windows
          path: target/x86_64-pc-windows-msvc/release/slipstream-client.exe
